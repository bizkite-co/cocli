sequenceDiagram
    participant C as Compactor (Local)
    participant W as WAL (wal/)
    participant P as Staging (processing/)
    participant CP as Checkpoint (prospects.checkpoint.usv)
    participant S3 as S3 Bucket

    Note over C,S3: 1. FREEZE PHASE (Atomic)
    C->>W: Rename wal/<shard>/ to processing/<timestamp>/<shard>/
    W-->>C: Move Complete

    Note over C,S3: 2. INGEST PHASE
    C->>P: Read all USVs in processing/<timestamp>/
    C->>CP: Load current Checkpoint
    C->>C: Merge & Deduplicate (WAL wins)

    Note over C,S3: 3. COMMIT PHASE (Atomic)
    C->>CP: Write to prospects.checkpoint.tmp
    C->>CP: os.replace(tmp, prospects.checkpoint.usv)
    C->>S3: PutObject (prospects.checkpoint.usv)

    Note over C,S3: 4. CLEANUP PHASE
    C->>P: Delete processing/<timestamp>/ (Local)
    C->>S3: Delete processed WAL objects (S3)
