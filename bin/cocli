#!/bin/bash

# Adhere to the XDG Base Directory Specification for data files.
# Use $XDG_DATA_HOME if set, otherwise default to ~/.local/share.
DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
COCLI_DIR="$DATA_HOME/cocli"

# Export the final paths for all sub-scripts to use.
export COMPANIES_DIR="$COCLI_DIR/companies"
export PEOPLE_DIR="$COCLI_DIR/people"

# Create the base directories if they don't exist.
mkdir -p "$COMPANIES_DIR"
mkdir -p "$PEOPLE_DIR"

# Get the absolute path of the script's directory, then go up one level to the project root.
# This makes the script runnable from anywhere.
BASE_DIR=$(cd "$(dirname "$0")/.." && pwd)

# --- Main Command Dispatcher ---

# The first argument is the command (e.g., 'add', 'find', 'help')
COMMAND=$1
shift # Remove the command from the argument list, so getopts can process the rest

case "$COMMAND" in
    add)
        # Pass all remaining arguments to the 'add' script
        "$BASE_DIR/lib/add" "$@"
        ;;
    import)
        # The second argument is the format name (e.g., 'lead-sniper')
        format="$1"
        # The third argument is the filepath
        filepath="$2"

        if [[ -z "$format" ]]; then
            echo "Error: Import format not specified."
            echo "Usage: cocli import <format> <filepath>"
            exit 1
        fi

        importer_script="$BASE_DIR/lib/importers/$format"

        if [ ! -f "$importer_script" ]; then
            echo "Error: Importer '$format' not found."
            exit 1
        fi

        # Execute the specific importer script with the filepath
        "$importer_script" "$filepath"
        ;;
    find)
        "$BASE_DIR/lib/find"
        ;;
    help)
        less "$BASE_DIR/HELP.md"
        ;;
    *)
        echo "Error: Unknown command '$COMMAND'"
        echo "Run 'cocli help' for a list of available commands."
        exit 1
        ;;
esac
